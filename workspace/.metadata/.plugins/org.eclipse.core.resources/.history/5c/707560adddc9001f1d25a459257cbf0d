package rs.ac.bg.etf.pp1;

import rs.ac.bg.etf.pp1.ast.*;
import rs.etf.pp1.mj.runtime.Code;
import rs.etf.pp1.symboltable.Tab;
import rs.etf.pp1.symboltable.concepts.Obj;
import rs.etf.pp1.symboltable.concepts.Struct;

public class CodeGenerator extends VisitorAdaptor {
	
	private int mainPC;
	
	public int getmainPc() {
		return this.mainPC;
	}

	/* METHOD DECLARATIONS */
	@Override
	public void visit(MethodTypeAndNameVoid methodTypeAndNameVoid) {
		methodTypeAndNameVoid.obj.setAdr(Code.pc);
		if(methodTypeAndNameVoid.getI1().equalsIgnoreCase("main")) {
			mainPC = Code.pc;
		}
		
		Code.put(Code.enter);
		Code.put(methodTypeAndNameVoid.obj.getLevel()); //b1
		Code.put(methodTypeAndNameVoid.obj.getLocalSymbols().size()); //b2
	}
	
	@Override
	public void visit(MethodTypeAndNameNonVoid methodTypeAndNameNonVoid) {
		methodTypeAndNameNonVoid.obj.setAdr(Code.pc);
		if(methodTypeAndNameNonVoid.getI2().equalsIgnoreCase("main")) {
			mainPC = Code.pc;
		}
		
		Code.put(Code.enter);
		Code.put(methodTypeAndNameNonVoid.obj.getLevel()); //b1
		Code.put(methodTypeAndNameNonVoid.obj.getLocalSymbols().size()); //b2
	}
	
	@Override
	public void visit(MethodDecl methodDecl) {
		Code.put(Code.exit);
		Code.put(Code.return_);
	}
	
	/* PRINT DECL */
	
	@Override
	public void visit(StatementPrintExpr statementPrintExpr) {
		Code.loadConst(0);
		if(statementPrintExpr.getExpr().struct.equals(Tab.charType)) {
			Code.put(Code.bprint);
		}else {
			Code.put(Code.print);
		}
	}
	
	@Override
	public void visit(StatementPrintSet statementPrintSet) {
		Code.loadConst(statementPrintSet.getN2());
		if(statementPrintSet.getExpr().struct.equals(Tab.charType)) {
			Code.put(Code.bprint);
		}else {
			Code.put(Code.print);
		}
	}
	
	/* EXPR */
	
	@Override
	public void visit(ExprMultipleTerm exprMultipleTerm) {
		if(exprMultipleTerm.getAddop() instanceof AddopAdd) {
			Code.put(Code.add);
		}else if(exprMultipleTerm.getAddop() instanceof AddopSubtract) {
			Code.put(Code.sub);
		}
	}
	
	@Override
	public void visit(TermMul termMul) {
		if(termMul.getMulop() instanceof MulopMultiply) {
			Code.put(Code.mul);
		}else if(termMul.getMulop() instanceof MulopDiv) {
			Code.put(Code.div);
		}else if(termMul.getMulop() instanceof MulopMod) {
			Code.put(Code.rem);
		}
	}
	
	//ovo radi na drugi nacin, ali mi nije jasno zasto ne moze ovako? Gen koda 9 impl 3 19:00
	@Override
	public void visit(ExprSingleTermMinus exprSingleTermMinus) {
		Code.put(Code.neg);
	}
	
	@Override
	public void visit(FactorNewArray factorNewArray) {
		Code.put(Code.newarray);
		Type tip = factorNewArray.getType();
		if(tip.struct.equals(Tab.charType)) {
			Code.put(0);
		}else {
			Code.put(1);
		}		
	}
	
	@Override
	public void visit(FactorNum factorNum) {
		Code.loadConst(factorNum.getN1());
	}
	
	@Override
	public void visit(FactorChar factorChar) {
		Code.loadConst(factorChar.getC1());
	}
	
	@Override
	public void visit(FactorBool factorBool) {
		Code.loadConst(factorBool.getB1());
	}
	

	@Override
	public void visit(FactorDesignator factorDesignator) {
		Code.load(factorDesignator.getDesignator().obj);
	}
	
	@Override
	public void visit(FactorDesignatorMethod factorDesignatorMethod) {
		int adr = factorDesignatorMethod.getFunctionName().getDesignator().obj.getAdr();
		int offset = adr - Code.pc;
		Code.put(Code.call);
		Code.put2(offset);
	}
	
	/* DESIGNATORS */

	//ovo je objasnjeno gen koda 9 impl 3 na 8. minuti
	@Override
	public void visit(DesignatorArrayName designatorArrayName) {
		Code.load(designatorArrayName.getDesignator().obj);
	}
	
	@Override
	public void visit(DesignatorStatementAssign designatorStatementAssign) {
		Code.store(designatorStatementAssign.getDesignator().obj);
	}

	@Override
	public void visit(DesignatorStatementIncrement designatorStatementIncrement) {
		Designator des = designatorStatementIncrement.getDesignator();
		if(des.obj.getKind() == Obj.Elem) { // obj 10. snimak impl 11:00
			//kada vracamo vrednost u store, moramo da imamo i adresu niza, koja se gubi u narednim instrukcijama
			//sa steka
			Code.put(Code.dup2);
		}
		Code.load(des.obj);
		Code.loadConst(1); // sta bi ovde bilo da je put 1? - put je za instr, load je za vrednosti na stek
		Code.put(Code.add);
		Code.store(des.obj);
	}
	
	@Override
	public void visit(DesignatorStatementDecrement designatorStatementDecrement) {
		Designator des = designatorStatementDecrement.getDesignator();
		if(des.obj.getKind() == Obj.Elem) {
			Code.put(Code.dup2);
		}
		Code.load(des.obj);
		Code.loadConst(1);
		Code.put(Code.sub);
		Code.store(des.obj);
	}
	
	@Override
	public void visit(DesignatorStatementFunctionCall designatorStatementFunctionCall) {
		int adr = designatorStatementFunctionCall.getFunctionName().getDesignator().obj.getAdr();
		int offset = adr - Code.pc ;
		Code.put(Code.call);
		Code.put2(offset);
		
		if(designatorStatementFunctionCall.getFunctionName().getDesignator().obj.getType() != Tab.noType) {
			Code.put(Code.pop);
		}
	}
	
	/* STATEMENTS */
	@Override
	public void visit(StatementReturn statementReturn) {
		Code.put(Code.exit);
		Code.put(Code.return_);
	}
	
	@Override
	public void visit(StatementReturnExpr statementReturnExpr) {
		Code.put(Code.exit);
		Code.put(Code.return_);
	}
	
	@Override
	public void visit(StatementRead statementRead) {
		if(statementRead.getDesignator().obj.getType().equals(Tab.charType)) {
			Code.put(Code.bread);
		}else {
			Code.put(Code.read);
		}
		Code.store(statementRead.getDesignator().obj);
	}
	
	
	
}
